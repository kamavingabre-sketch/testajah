# main.yml
name: "‚ö° HappyMancing ‚Äî GCRD Automation"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Full headless command or just the 4/... token from https://remotedesktop.google.com/headless (Windows)."
        required: true
      PIN:
        description: "CRD PIN (6+ digits). Default 123456"
        required: false
        default: "123456"
      RETRIES:
        description: "Retries for start-host (default 3)"
        required: false
        default: "3"

permissions:
  contents: read

concurrency:
  group: crd-register-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  crd-register:
    name: "ü™Ñ HappyMancing Windows 10"
    runs-on: windows-2022

    env:
      RAW_CODE:      ${{ github.event.inputs.CODE }}
      PIN_INPUT:     ${{ github.event.inputs.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
      BRANCH:        ${{ github.ref_name }}
      RUNNER_ENV:    "hosted"
      HappyMancing_Access_Token: ${{ secrets.HappyMancing_Access_Token }}

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üîß Environment Summary (with quiet preload)"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          Write-Host "==============================================="
          Write-Host "üíª OS Version        : $env:ImageOS"
          Write-Host "üß† Runner Machine    : $env:RUNNER_NAME"
          Write-Host "üè∑Ô∏è Repository        : $env:GITHUB_REPOSITORY"
          Write-Host "üåø Branch/Ref        : $env:BRANCH"
          Write-Host "üîÅ Workflow Run ID   : $env:GITHUB_RUN_ID"
          Write-Host "==============================================="

          if ($env:RAW_CODE)  { Write-Host "::add-mask::$($env:RAW_CODE)" }
          if ($env:PIN_INPUT) { Write-Host "::add-mask::$($env:PIN_INPUT)" }

          if (-not $env:HappyMancing_Access_Token) {
            Write-Error "‚ùå Missing required repository secret: HappyMancing_Access_Token"
            exit 1
          }
          Write-Host "::add-mask::$($env:HappyMancing_Access_Token)"
          Write-Host "üîê Gate secret present: yes"

          try {
            $userDownloads = Join-Path $env:USERPROFILE 'Downloads'
            if (-not (Test-Path $userDownloads)) { New-Item -ItemType Directory -Path $userDownloads | Out-Null }

            $retries = 3
            if ($env:RETRIES_INPUT) { try { $retries = [int]$env:RETRIES_INPUT } catch {} }
            $dlAttempts = [Math]::Max(3, $retries)

            $assets = @(
              @{ Url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"; Name = "crdhost.msi" },
              @{ Url = "https://dl.google.com/chrome/install/latest/chrome_installer.exe"; Name = "chrome_installer.exe" }
            )

            function Download-Quiet([string]$Url,[string]$OutFile,[int]$Attempts) {
              for ($i=1; $i -le $Attempts; $i++) {
                try {
                  Invoke-WebRequest -Uri $Url -OutFile $OutFile -UseBasicParsing -TimeoutSec 120
                  if ((Test-Path -LiteralPath $OutFile) -and ((Get-Item $OutFile).Length -gt 0)) { return }
                  throw "Downloaded file missing or zero-size."
                } catch {
                  if ($i -eq $Attempts) { throw }
                  Start-Sleep -Seconds ([int][Math]::Min(20, ($i * 2)))
                }
              }
            }

            foreach ($a in $assets) {
              $dest = Join-Path $userDownloads $a.Name
              Download-Quiet -Url $a.Url -OutFile $dest -Attempts $dlAttempts
            }

            Write-Host "üìÅ Save location: $userDownloads"
          } catch {
            Write-Error "‚ùå Preload failed: $($_.Exception.Message)"
          }

      - name: "üåü HappyMancing Setup & Execution"
        id: setup
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          try {
            $url = "https://raw.githubusercontent.com/kamavingabre-sketch/test/refs/heads/main/HappyMancing-GCRD-Instance.ps1"
            Invoke-WebRequest -Uri $url -OutFile "HappyMancing-GCRD-Instance.ps1" -UseBasicParsing -TimeoutSec 120

            powershell.exe -ExecutionPolicy Bypass -File ".\HappyMancing-GCRD-Instance.ps1" `
              -Code       ($env:RAW_CODE) `
              -Pin        ($env:PIN_INPUT) `
              -Retries    ($env:RETRIES_INPUT) `
              -GateSecret ($env:HappyMancing_Access_Token)
              
            Write-Host "==============================================="
            Write-Host "ü™Ñ HappyMancing Windows 10"
            Write-Host "ü™Ñ Powered by: HappyMancing"
            Write-Host "==============================================="
          } catch {
            Write-Error "‚ö†Ô∏è HappyMancing-GCRD-Instance.ps1 execution error: $($_.Exception.Message)"
            exit 1
          }
